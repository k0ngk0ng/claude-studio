name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release-macos:
    name: Release (macOS)
    runs-on: macos-latest
    environment: production
    env:
      CSC_LINK: ${{ secrets.CSC_LINK }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Import Apple Developer ID certificate
        if: env.CSC_LINK != ''
        env:
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          # Decode the .p12 certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "$CSC_LINK" | base64 --decode > "$CERTIFICATE_PATH"

          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate into keychain
          security import "$CERTIFICATE_PATH" -P "$CSC_KEY_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add keychain to search list (preserve existing keychains)
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Verify certificate was imported
          echo "=== Keychain search list ==="
          security list-keychains -d user
          echo "=== Signing identities ==="
          security find-identity -v -p codesigning
          echo "=== Certificate imported successfully ==="

      - name: Sync version from git tag
        run: npm run version:sync

      - name: Verify signing identity before build
        run: |
          echo "=== Keychain search list ==="
          security list-keychains -d user
          echo "=== All codesigning identities ==="
          security find-identity -v -p codesigning
          echo "=== Developer ID identities ==="
          security find-identity -v -p codesigning | grep "Developer ID" || echo "WARNING: No Developer ID identity found!"

      - name: Make distributables
        run: npm run make
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_STUDIO_CDN_URL: ${{ vars.ALIYUN_OSS_CDN_URL }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            out/make/**/*.dmg
            out/make/**/*.zip
          retention-days: 5

  release-windows:
    name: Release (Windows)
    runs-on: windows-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Sync version from git tag
        run: npm run version:sync

      - name: Extract version
        id: version
        shell: bash
        run: |
          VER=$(node -p "require('./package.json').version")
          echo "VERSION=$VER" >> "$GITHUB_OUTPUT"

      - name: Package app
        run: npm run package
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_STUDIO_CDN_URL: ${{ vars.ALIYUN_OSS_CDN_URL }}

      - name: Install NSIS
        shell: pwsh
        run: |
          $maxRetries = 3
          for ($i = 1; $i -le $maxRetries; $i++) {
            Write-Host "Attempt $i of $maxRetries..."
            choco install nsis -y
            if ($LASTEXITCODE -eq 0) { break }
            if ($i -lt $maxRetries) {
              Write-Host "Failed, retrying in 30 seconds..."
              Start-Sleep -Seconds 30
            } else {
              Write-Host "All attempts failed"
              exit 1
            }
          }

      - name: Find packaged app directory
        id: appdir
        shell: bash
        run: |
          APP_DIR=$(find out -maxdepth 1 -type d -name "*-win32-*" | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: Could not find packaged app directory in out/"
            ls -la out/
            exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> "$GITHUB_OUTPUT"
          echo "Found app directory: $APP_DIR"

      - name: Build NSIS installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\NSIS\makensis.exe" /V4 /DPRODUCT_VERSION=${{ steps.version.outputs.VERSION }} "/DAPP_DIR=%CD%\${{ steps.appdir.outputs.APP_DIR }}" installer\installer.nsi

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            installer/ClaudeStudio-*-Setup.exe
          retention-days: 5

  release-linux:
    name: Release (Linux)
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg fakeroot rpm

      - name: Install dependencies
        run: npm ci

      - name: Sync version from git tag
        run: npm run version:sync

      - name: Make distributables
        run: ./node_modules/.bin/electron-forge make
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_STUDIO_CDN_URL: ${{ vars.ALIYUN_OSS_CDN_URL }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: |
            out/make/**/*.deb
            out/make/**/*.rpm
            out/make/**/*.zip
          retention-days: 5

  release-server:
    name: Release (Server)
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Build server
        working-directory: server
        run: npm run build

      - name: Package server tarball
        run: |
          mkdir -p server-release
          cp -r server/dist server-release/
          cp server/package.json server-release/
          cp server/admin.mjs server-release/
          cp server/.env.example server-release/
          cp server/claude-studio-server.service server-release/
          cp server/deploy.sh server-release/
          cp server/upgrade.sh server-release/
          cp server/README.md server-release/
          # Install production deps into tarball (no --ignore-scripts, better-sqlite3 needs native build)
          cd server-release
          npm install --omit=dev
          cd ..
          tar -czf claude-studio-server.tar.gz -C server-release .

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-server
          path: claude-studio-server.tar.gz
          retention-days: 5

  publish-release:
    name: Publish GitHub Release & Upload to OSS
    runs-on: ubuntu-latest
    needs: [release-macos, release-windows, release-linux, release-server]
    environment: production
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      - name: List artifacts
        run: find artifacts/ -type f | head -50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/release-macos/**/*
            artifacts/release-windows/**/*
            artifacts/release-linux/**/*
            artifacts/release-server/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ─── Upload to Aliyun OSS ────────────────────────────────────────
      - name: Extract tag version
        id: version
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Install ossutil
        run: |
          curl -fsSL https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash
          ossutil --version

      - name: Configure ossutil
        run: |
          ossutil config \
            -e https://${{ secrets.ALIYUN_OSS_ENDPOINT }} \
            -i ${{ secrets.ALIYUN_OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}
          echo "Endpoint: https://${{ secrets.ALIYUN_OSS_ENDPOINT }}"
          echo "Bucket: ${{ secrets.ALIYUN_OSS_BUCKET }}"
          # Verify access
          ossutil ls oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/ --limited-num 1 || echo "Warning: cannot list bucket"

      - name: Flatten artifacts for upload
        run: |
          mkdir -p upload/
          find artifacts/ -type f \
            -exec cp {} upload/ \;
          # Replace spaces with dots in filenames (match GitHub Release behavior)
          cd upload/
          for f in *; do
            newname="$(echo "$f" | tr ' ' '.')"
            if [ "$f" != "$newname" ]; then
              mv "$f" "$newname"
            fi
          done
          cd ..
          echo "Files to upload:"
          ls -lh upload/

      - name: Upload to OSS — claude-studio/releases/${{ steps.version.outputs.TAG }}/
        run: |
          ossutil cp -r upload/ \
            oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/${{ steps.version.outputs.TAG }}/ \
            --force

      - name: Upload to OSS — claude-studio/releases/latest/
        run: |
          ossutil cp -r upload/ \
            oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/latest/ \
            --force

      - name: Generate cdn-urls.json
        run: |
          CDN_BASE="${{ vars.ALIYUN_OSS_CDN_URL }}/claude-studio/releases/${{ steps.version.outputs.TAG }}"
          TAG="${{ steps.version.outputs.TAG }}"
          echo '{}' > cdn-urls.json
          # Build JSON with all file URLs
          node -e "
            const fs = require('fs');
            const files = fs.readdirSync('upload/');
            const base = '${CDN_BASE}';
            const tag = '${TAG}';
            const urls = { version: tag.replace('v',''), cdnBase: base, files: {} };
            for (const f of files) {
              urls.files[f] = base + '/' + f;
            }
            fs.writeFileSync('cdn-urls.json', JSON.stringify(urls, null, 2));
            console.log(JSON.stringify(urls, null, 2));
          "

      - name: Upload cdn-urls.json to OSS
        run: |
          ossutil cp cdn-urls.json \
            oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/${{ steps.version.outputs.TAG }}/cdn-urls.json \
            --force
          ossutil cp cdn-urls.json \
            oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/latest/cdn-urls.json \
            --force

      - name: Verify OSS upload
        run: |
          echo "=== claude-studio/releases/${{ steps.version.outputs.TAG }}/ ==="
          ossutil ls oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/${{ steps.version.outputs.TAG }}/ --short
          echo ""
          echo "=== claude-studio/releases/latest/ ==="
          ossutil ls oss://${{ secrets.ALIYUN_OSS_BUCKET }}/claude-studio/releases/latest/ --short
